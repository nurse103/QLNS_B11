```sql
CREATE TABLE dsnv (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- ID tự tăng
    ho_va_ten TEXT NOT NULL,           -- Họ và tên
    ngay_sinh DATE,                    -- Ngày sinh
    gioi_tinh TEXT,                    -- Giới tính (Nam/Nữ)
    cap_bac TEXT,                      -- Cấp bậc
    chuc_vu TEXT,                      -- Chức vụ
    cccd TEXT,                         -- Căn cước công dân
    ngay_cap_cccd DATE,                -- Ngày cấp CCCD
    cmqd TEXT,                         -- Chứng minh quân đội
    ngay_cap_cmqd DATE,                -- Ngày cấp CMQĐ
    que_quan TEXT,                     -- Quê quán
    noi_o_hien_nay TEXT,               -- Nơi ở hiện nay
    dien_thoai TEXT,                   -- Số điện thoại
    thang_nam_tuyen_dung DATE,         -- Tháng năm tuyển dụng
    thang_nam_nhap_ngu DATE,           -- Tháng năm nhập ngũ
    ngay_ve_khoa_cong_tac DATE,        -- Ngày về khoa công tác
    trang_thai TEXT,                   -- Trạng thái (Đang làm việc, Đã nghỉ, v.v.)
    thang_nam_roi_khoa DATE,           -- Tháng năm rời khoa (nếu có)
    trang_thai_roi_khoa TEXT,          -- Trạng thái rời khoa (Nghỉ hưu, Chuyển công tác...)
    noi_den TEXT,                      -- Nơi đến (đơn vị mới hoặc địa phương về hưu)
    avatar TEXT,                       -- Link/Path ảnh đại diện
    ghi_chu TEXT,                      -- Ghi chú thêm
    dien_quan_ly TEXT,                 -- Diện quản lý (Cán bộ/Quân lực)
    ngay_vao_dang DATE,                -- Ngày vào đảng
    ngay_chinh_thuc DATE,              -- Ngày chính thức
    so_the_dang TEXT,                  -- Số thẻ đảng
    ngay_cap_the_dang DATE,            -- Ngày cấp thẻ đảng
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Migration for existing table
-- ALTER TABLE dsnv ADD COLUMN dien_quan_ly TEXT;
-- ALTER TABLE dsnv ADD COLUMN ngay_vao_dang DATE;
-- ALTER TABLE dsnv ADD COLUMN ngay_chinh_thuc DATE;
-- ALTER TABLE dsnv ADD COLUMN so_the_dang TEXT;
-- ALTER TABLE dsnv ADD COLUMN so_the_dang TEXT;
-- ALTER TABLE dsnv ADD COLUMN ngay_cap_the_dang DATE;
-- ALTER TABLE dsnv ADD COLUMN doi_tuong TEXT;

CREATE TABLE gia_dinh (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết với bảng dsnv
    moi_quan_he TEXT NOT NULL,         -- Mối quan hệ (Bố, Mẹ, Vợ/Chồng, Con...)
    ho_va_ten TEXT NOT NULL,           -- Họ và tên người thân
    nam_sinh INTEGER,                  -- Năm sinh
    nghe_nghiep TEXT,                  -- Nghề nghiệp
    so_dien_thoai TEXT,                -- Số điện thoại
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE TABLE len_luong (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết với bảng dsnv
    thang_nam_nhan DATE,               -- Tháng năm nhận
    loai_nhom TEXT,                    -- Loại nhóm
    bac TEXT,                          -- Bậc
    he_so FLOAT,                       -- Hệ số
    phan_tram_tnvk FLOAT,              -- % TNVK
    hsbl FLOAT,                        -- HSBL
    quan_ham TEXT,                     -- Quân hàm
    hinh_thuc TEXT,                    -- Hình thức lên lương / QH
    file_qd TEXT,                      -- File quyết định (link/path)
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE TABLE qua_trinh_cong_tac (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết với bảng dsnv
    tu_thang_nam DATE,                 -- Từ tháng năm
    den_thang_nam DATE,                -- Đến tháng năm
    don_vi_cong_tac TEXT,              -- Đơn vị công tác
    cap_bac TEXT,                      -- Cấp bậc
    chuc_vu TEXT,                      -- Chức vụ
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE TABLE qua_trinh_dao_tao (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết với bảng dsnv
    tu_thang_nam DATE,                 -- Từ tháng năm
    den_thang_nam DATE,                -- Đến tháng năm
    ten_co_so_dao_tao TEXT,            -- Tên cơ sở đào tạo
    nganh_dao_tao TEXT,                -- Ngành đào tạo
    trinh_do_dao_tao TEXT,             -- Trình độ đào tạo
    hinh_thuc_dao_tao TEXT,            -- Hình thức đào tạo
    xep_loai_tot_nghiep TEXT,          -- Xếp loại tốt nghiệp
    anh_van_bang TEXT,                 -- Ảnh văn bằng (link/path)
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE TABLE cchn (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết với bảng dsnv
    so_cchn TEXT,                      -- Số CCHN
    ngay_cap DATE,                     -- Ngày cấp
    pham_vi_hoat_dong TEXT,            -- Phạm vi hoạt động
    ngay_het_han DATE,                 -- Ngày hết hạn
    anh_cchn TEXT,                     -- Ảnh CCHN (link/path)
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE TABLE bhyt_than_nhan (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết với bảng dsnv
    moi_quan_he TEXT NOT NULL,         -- Mối quan hệ
    ho_va_ten TEXT NOT NULL,           -- Họ và tên
    ngay_sinh DATE,                    -- Ngày sinh
    gioi_tinh TEXT,                    -- Giới tính
    ma_so_bhyt TEXT,                   -- Mã số BHYT
    noi_cu_tru TEXT,                   -- Nơi cư trú
    cccd TEXT,                         -- CCCD
    sd_tu_ngay DATE,                   -- SD từ ngày
    sd_den_ngay DATE,                  -- SD đến ngày
    anh_bhyt TEXT,                     -- Ảnh BHYT (link/path)
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

CREATE TABLE quan_ly_phep (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    dsnv_id BIGINT REFERENCES dsnv(id) ON DELETE CASCADE, -- Liên kết nhân viên
    ho_va_ten TEXT,                    -- Họ và tên (Snapshot hoặc nhập tay)
    cap_bac TEXT,                      -- Cấp bậc (Snapshot)
    chuc_vu TEXT,                      -- Chức vụ (Snapshot)
    loai_nghi TEXT,                    -- Loại (Phép/Tranh thủ)
    tu_ngay DATE,                      -- Từ ngày
    den_ngay DATE,                     -- Đến ngày
    ly_do_nghi TEXT,                   -- Lý do nghỉ
    noi_dang_ky_nghi TEXT,             -- Nơi đăng ký nghỉ
    ghi_chu TEXT,                      -- Ghi chú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- Bật Row Level Security (RLS)
ALTER TABLE dsnv ENABLE ROW LEVEL SECURITY;
ALTER TABLE gia_dinh ENABLE ROW LEVEL SECURITY;
ALTER TABLE len_luong ENABLE ROW LEVEL SECURITY;
ALTER TABLE qua_trinh_cong_tac ENABLE ROW LEVEL SECURITY;
ALTER TABLE qua_trinh_dao_tao ENABLE ROW LEVEL SECURITY;
ALTER TABLE cchn ENABLE ROW LEVEL SECURITY;
ALTER TABLE bhyt_than_nhan ENABLE ROW LEVEL SECURITY;
ALTER TABLE quan_ly_phep ENABLE ROW LEVEL SECURITY;

-- Tạo Policies cho phép full quyền (Select, Insert, Update, Delete) cho tất cả user (hoặc authenticated user)
-- Ở đây set cho public để dễ dàng test, development.
CREATE POLICY "Enable all access for all users" ON dsnv FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON gia_dinh FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON len_luong FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON qua_trinh_cong_tac FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON qua_trinh_dao_tao FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON cchn FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON bhyt_than_nhan FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for all users" ON quan_ly_phep FOR ALL USING (true) WITH CHECK (true);

CREATE TABLE lich_cong_tac (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    noi_dung TEXT,                      -- Nội dung
    chi_tiet TEXT,                      -- Chi tiết
    ngay_bat_dau TIMESTAMP WITH TIME ZONE, -- Ngày bắt đầu
    ngay_ket_thuc TIMESTAMP WITH TIME ZONE, -- Ngày kết thúc
    nguoi_thuc_hien JSONB,              -- Danh sách người thực hiện (JSON array chứa ID nhân sự)
    file_dinh_kem TEXT,                 -- Đường dẫn file (PDF/Ảnh) lưu trong storage
    trang_thai TEXT DEFAULT 'Đang thực hiện', -- Trạng thái: Đang thực hiện, Quá hạn, Hoàn thành
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

ALTER TABLE lich_cong_tac ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable all access for all users" ON lich_cong_tac FOR ALL USING (true) WITH CHECK (true);

-- Storage Bucket: lich_cong_tac
INSERT INTO storage.buckets (id, name, public) 
VALUES ('lich_cong_tac', 'lich_cong_tac', true)
ON CONFLICT (id) DO NOTHING;

-- Storage Policy
CREATE POLICY "Enable all access for lich_cong_tac bucket" ON storage.objects 
FOR ALL USING (bucket_id = 'lich_cong_tac') 
WITH CHECK (bucket_id = 'lich_cong_tac');
```
